@page "/register"
@using DailyNotes.Models
@inject DailyNotes.Services.UserService UserService
@inject NavigationManager Nav

<h2 class="page-title">Create Account</h2>

<div class="form-box">

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-box">@errorMessage</div>
    }

    <label>Name</label>
    <input class="text-input" @bind="name" placeholder="John Smith" />

    <label>Email</label>
    <input class="text-input" @bind="email" type="email" placeholder="example123@gmail.com" />

    <label>Age</label>
    <input type="number" class="text-input" @bind="age" placeholder="18" />

    <label>Password</label>
    <input class="text-input" @bind="password" type="password" placeholder="Min 6 characters" />

    <button type="button" class="primary-btn" @onclick="RegisterUser">
        Register
    </button>

    <p class="mt-3">
        Already have an account?
        <a href="/login"> Login here</a>
    </p>
</div>

@code {
    string name = "";
    string email = "";
    int age = 0;
    string password = "";
    string errorMessage = "";

    async Task RegisterUser()
    {
        errorMessage = "";

        Console.WriteLine($"[DEBUG] Start RegisterUser: name={name}, email={email}, age={age}");

        // ---- Validations ----
        if (string.IsNullOrWhiteSpace(name))
        {
            errorMessage = "Name is required.";
            Console.WriteLine("[DEBUG] Validation failed: Name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(email) || !email.Contains("@") || !email.Contains("."))
        {
            errorMessage = "Please enter a valid email.";
            Console.WriteLine("[DEBUG] Validation failed: Invalid email");
            return;
        }

        if (age <= 0)
        {
            errorMessage = "Please enter a valid age.";
            Console.WriteLine("[DEBUG] Validation failed: Invalid age");
            return;
        }

        if (string.IsNullOrWhiteSpace(password) || password.Length < 6)
        {
            errorMessage = "Password must have at least 6 characters.";
            Console.WriteLine("[DEBUG] Validation failed: Password too short");
            return;
        }

        try
        {
            Console.WriteLine("[DEBUG] Checking if email exists in DB...");
            var existing = await UserService.GetByEmailAsync(email);
            if (existing != null)
            {
                errorMessage = "This email is already registered.";
                Console.WriteLine("[DEBUG] Email already registered");
                return;
            }

            // ---- Create the user ----
            var newUser = new User
            {
                UserName = name,
                Email = email,
                PasswordHash = password
            };

            Console.WriteLine("[DEBUG] Sending CreateAsync request to backend...");
            await UserService.CreateAsync(newUser);
            Console.WriteLine("[DEBUG] User created successfully!");

            // ---- Redirect ----
            Nav.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating user: {ex.Message}";
            Console.WriteLine($"[DEBUG] Exception: {ex.Message}");
        }
    }
}
