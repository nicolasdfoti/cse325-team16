@page "/"
@using DailyNotes.Models
@inject DailyNotes.Services.EntryService EntryService
@inject DailyNotes.Services.AuthStateService AuthStateService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<h1 class="homepage-title">
    @if (AuthStateService.IsAuthenticated)
    {
        <text>Good to see you again, @AuthStateService.CurrentUser.UserName ✨</text>
    }
    else
    {
        <text>Welcome to Daily Notes</text>
    }
</h1>
<p class="homepage-subtitle">A safe space to write, heal, and grow one day at a time ✨</p>

<div class="hero-container">
    <button class="primary-btn hero-cta-left" @onclick="GoToPrompt">
        Go to Daily Prompt
    </button>

    <img src="sample-data/hero.png" alt="Welcome" class="hero-image-full" />
</div>

<h2 class="section-title">🔥 Most Popular Entries This Week</h2>

@if (topEntries == null || !topEntries.Any())
{
    <p>No public entries yet.</p>
}
else
{
    <div class="horizontal-scroll">
        @foreach (var entry in topEntries)
        {
            <div class="entry-card">
                <h3>@entry.Title</h3>

                <p>@(entry.Content.Length > 70 
                    ? entry.Content.Substring(0, 70) + "..." 
                    : entry.Content)</p>

                <p>❤️ @entry.Likes likes</p>

                <button class="secondary-btn" @onclick="() => ViewEntry(entry.Id)">
                    View
                </button>
            </div>
        }
    </div>
}

@code {
    List<Entry> topEntries = new();
    string localName;

    protected override async Task OnInitializedAsync()
    {

        AuthStateService.OnChange += AuthStateChanged;

        await AuthStateService.EnsureInitializedAsync();
        StateHasChanged();
       
        try
        {
            localName = await JS.InvokeAsync<string>("localStorage.getItem", "userName");
            var publicEntries = await EntryService.GetPublicEntriesAsync();
            topEntries = publicEntries?
                .OrderByDescending(e => e.Likes)
                .Take(5)
                .ToList() ?? new List<Entry>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entries: {ex.Message}");
        }
    }

    private void AuthStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthStateService.OnChange -= AuthStateChanged;
    }

    void GoToPrompt()
    {
        Navigation.NavigateTo("/newentry");
    }

    void ViewEntry(string id)
    {
        Navigation.NavigateTo($"/view/{id}");
    }
}