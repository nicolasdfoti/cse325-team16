@using DailyNotes.Services
@inject AuthStateService AuthStateService

<div class="sidebar">
    <!-- Hamburger button (visible on mobile) -->
    <button class="hamburger" @onclick="ToggleNavMenu">
        ☰
    </button>

    <div class="nav-links @(collapseNavMenu ? "" : "show")">
        <NavLink href="/" Match="NavLinkMatch.All">Home</NavLink>

        @if (isAuthenticated)
        {
            <NavLink href="/prompt">Daily Prompt</NavLink>
            <NavLink href="/entries">My Entries</NavLink>
            <NavLink href="/newentry">Create Entry</NavLink>
            <NavLink href="/public">Public Entries</NavLink>
            <NavLink href="/logout">Log Out</NavLink>
        }
        else
        {
            <NavLink href="/login">Log In</NavLink>
            <NavLink href="/register">Register</NavLink>
        }
    </div>

    <div class="brand">
        <h2>DailyNotes</h2>
        <div class="tagline">A safe space to write, heal, and grow</div>
    </div>
</div>

@code {
    private bool collapseNavMenu = true;
    private bool isAuthenticated = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await AuthStateService.EnsureInitializedAsync();
        
        AuthStateService.OnChange += AuthStateChanged;
        await UpdateAuthState();
    }

    private async Task UpdateAuthState()
    {
        isAuthenticated = AuthStateService.IsAuthenticated;
        userName = AuthStateService.CurrentUser?.UserName ?? string.Empty;
        StateHasChanged();
    }

    private async void AuthStateChanged()
    {
        await UpdateAuthState();
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    public void Dispose()
    {
        AuthStateService.OnChange -= AuthStateChanged;
    }
}