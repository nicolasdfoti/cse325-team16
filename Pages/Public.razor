@page "/public"
@using DailyNotes.Models
@using DailyNotes.Services

@inject EntryService entryService

<h2 class="page-title">Public Entries</h2>

<div class="entry-list">
    @foreach (var entry in publicEntries)
    {
        if (!newCommentText.ContainsKey(entry.Id))
            newCommentText[entry.Id] = "";

        <div class="entry-card">
            <h3>@entry.Title</h3>
            <p>@(entry.Content.Length > 150 ? entry.Content[..150] + "..." : entry.Content)</p>
            <small>Published: @entry.CreatedAt.ToShortDateString()</small>

            <div class="reaction-buttons">
                <button class="primary-btn" @onclick="() => Like(entry.Id)">üëç @entry.Likes</button>
                <button class="danger-btn" @onclick="() => Dislike(entry.Id)">üëé @entry.Dislikes</button>
            </div>

            <div class="comments-section">
                <h4>Comments</h4>

                @if (!entry.Comments.Any())
                {
                    <p>No comments yet.</p>
                }
                else
                {
                    @foreach (var c in entry.Comments)
                    {
                        <div class="comment-card">
                            <strong>@c.Author</strong>
                            <p>@c.Text</p>
                            <small>@c.CreatedAt.ToShortDateString()</small>
                        </div>
                    }
                }

                <textarea @bind="newCommentText[entry.Id]" class="text-area"></textarea>
                <button class="secondary-btn" @onclick="() => AddComment(entry.Id)">üí¨ Comment</button>
            </div>
        </div>
    }
</div>

@code {
    List<Entry> publicEntries = new();
    Dictionary<int, string> newCommentText = new();

    protected override async Task OnInitializedAsync()
    {
        publicEntries = await entryService.GetPublicEntriesAsync();

        foreach (var e in publicEntries)
            newCommentText[e.Id] = "";
    }

    async Task Like(int id)
    {
        await entryService.LikeEntryAsync(id);
        publicEntries = await entryService.GetPublicEntriesAsync();
    }

    async Task Dislike(int id)
    {
        await entryService.DislikeEntryAsync(id);
        publicEntries = await entryService.GetPublicEntriesAsync();
    }

    async Task AddComment(int entryId)
    {
        if (string.IsNullOrWhiteSpace(newCommentText[entryId]))
            return;

        await entryService.AddCommentAsync(entryId, "An√≥nimo", newCommentText[entryId]);

        newCommentText[entryId] = "";

        publicEntries = await entryService.GetPublicEntriesAsync();
    }
}
